#include "core/assets/asset_manager.h"
#include "core/common.h"
#include "entities/entities_manager.h"
#include "game/game_manager.h"
#include "input/input_manager.h"
#include "render/renderer.h"
#include <SDL2/SDL_gamecontroller.h>
#include <raylib.h>

#include "rng.h"

int main(void) {
  seed_rng();

  SetConfigFlags(FLAG_VSYNC_HINT);

  InitWindow(GAMEPLAY_WIDTH, GAMEPLAY_HEIGHT, "Bomber Clean");

  InitAudioDevice();

  entities_manager_init();
  input_manager_init();
  asset_manager_init();
  game_manager_init();

  RenderTexture2D target = LoadRenderTexture(GAMEPLAY_WIDTH, GAMEPLAY_HEIGHT);

  while (!WindowShouldClose()) {
    float dt = GetFrameTime();

    // Desenha na resolução padrão
    BeginTextureMode(target);
    ClearBackground(WHITE);

    renderer_draw_game();

    EndTextureMode();

    // Desenha na resolução que estiver
    BeginDrawing();
    ClearBackground(BLACK);

    int offsetX = (GetScreenWidth() - GAMEPLAY_WIDTH) / 2;
    int offsetY = (GetScreenHeight() - GAMEPLAY_HEIGHT) / 2;

    if (IsWindowFullscreen() || GetScreenWidth() == 1920)
      DrawTexture(*asset_manager_get_fullscreen_texture(), 0, 0, WHITE);

    DrawTextureRec(target.texture,
                   (Rectangle){0, 0, GAMEPLAY_WIDTH, -GAMEPLAY_HEIGHT},
                   (Vector2){offsetX, offsetY}, WHITE);

    EndDrawing();
  }

  CloseAudioDevice();
  CloseWindow();

  return 0;
}
